<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sortable Board</title>
    <style>
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      .routes-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 900px) { .routes-grid { grid-template-columns: 1fr 1fr; } }
      @media (min-width: 1300px) { .routes-grid { grid-template-columns: 1fr 1fr 1fr; } }
      .card { background: #ffffff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06); }
      .card-body { padding: 16px; }
      .card-header { display: flex; align-items: center; justify-content: space-between; }
      .card-title { font-weight: 700; font-size: 20px; color: #111827; }
      .pill { background: #EEF2FF; color: #4338CA; font-weight: 600; font-size: 12px; padding: 4px 10px; border-radius: 9999px; }
      .meta { display:flex; align-items:center; color:#6B7280; font-size: 14px; margin-top: 6px; }
      .stop { padding-top: 16px; border-top: 1px solid #F3F4F6; }
      .stop:first-child { padding-top: 0; border-top: none; }
      .stop-row { display:flex; align-items:flex-start; }
      .stop-num { background:#E5E7EB; color:#374151; width:32px; height:32px; border-radius:9999px; display:flex; align-items:center; justify-content:center; font-weight:700; flex-shrink:0; }
      .stop-content { margin-left: 12px; width: 100%; }
      .stop-address { font-weight:600; color:#1F2937; display:flex; align-items:center; gap:8px; }
      .handle { cursor: grab; user-select: none; color:#6B7280; }
      .passenger { color:#4B5563; margin-top: 4px; display:flex; align-items:center; gap:8px; }
      .ghost { opacity: 0.4; }
      .chosen { background: #F3F4F6; }
      .drag-container { min-height: 10px; }
      .passenger-pill { padding: 2px 8px; background: #fee2e2; color: #991b1b; border-radius: 8px; display:inline-block; }
      .stop-chip { display:inline-block; padding: 6px 12px; background: #fecaca; color:#991b1b; border-radius: 8px; margin-right: 8px; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      let __componentId = null;

      function setComponentReady() { window.parent.postMessage({ isStreamlitMessage: true, type: 'streamlit:componentReady', isReady: true }, '*'); }
      function setFrameHeight(h) { window.parent.postMessage({ isStreamlitMessage: true, type: 'streamlit:setFrameHeight', height: h }, '*'); }
      function sendValue(value) { if (__componentId !== null) { window.parent.postMessage({ isStreamlitMessage: true, type: 'streamlit:componentValue', id: __componentId, value }, '*'); } }

      function render(vans) {
        const root = document.getElementById('root');
        root.innerHTML = '';

        const grid = document.createElement('div');
        grid.className = 'routes-grid';

        vans.forEach((van) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.dataset.section = van.section;
          card.dataset.vehicleId = van.vehicle_id;

          const body = document.createElement('div');
          body.className = 'card-body';

          const header = document.createElement('div');
          header.className = 'card-header';
          const title = document.createElement('div');
          title.className = 'card-title';
          title.textContent = van.title;
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = `${van.stops.length} Stops`;
          header.appendChild(title); header.appendChild(pill);
          body.appendChild(header);

          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.innerHTML = `<svg class='clock' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'/></svg><span>Estimated time: ${van.duration_text || '—'}</span>`;
          body.appendChild(meta);

          // Stop chips row with sortable for stops
          const stopChipsRow = document.createElement('div');
          stopChipsRow.className = 'drag-container';
          stopChipsRow.style.margin = '8px 0 12px 0';
          body.appendChild(stopChipsRow);

          // Stops container
          const stopsContainer = document.createElement('div');
          body.appendChild(stopsContainer);

          van.stops.forEach((s, idx) => {
            const chip = document.createElement('span');
            chip.className = 'stop-chip';
            chip.setAttribute('draggable', 'true');
            chip.textContent = s.address;
            chip.dataset.address = s.address;
            stopChipsRow.appendChild(chip);

            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop';
            const row = document.createElement('div');
            row.className = 'stop-row';
            const num = document.createElement('div');
            num.className = 'stop-num';
            num.textContent = (idx+1);
            const content = document.createElement('div');
            content.className = 'stop-content';
            const addressDiv = document.createElement('div');
            addressDiv.className = 'stop-address';
            addressDiv.innerHTML = `<span class="handle">⋮⋮</span><span>${s.address}</span>`;
            content.appendChild(addressDiv);

            // Passenger container
            const paxContainer = document.createElement('div');
            paxContainer.className = 'drag-container';
            paxContainer.dataset.address = s.address;
            content.appendChild(paxContainer);

            (s.passengers || []).forEach((p) => {
              const pax = document.createElement('div');
              pax.className = 'passenger';
              pax.setAttribute('draggable', 'true');
              pax.innerHTML = `<span class="handle">⋮⋮</span><span class="passenger-pill">${p}</span>`;
              pax.dataset.passenger = p;
              pax.dataset.address = s.address;
              paxContainer.appendChild(pax);
            });

            row.appendChild(num); row.appendChild(content);
            stopDiv.appendChild(row);
            stopsContainer.appendChild(stopDiv);
          });

          card.appendChild(body);
          grid.appendChild(card);

          // Native DnD for stop chips (reorder within a van)
          let chipDragEl = null;
          stopChipsRow.addEventListener('dragstart', (e) => {
            const target = e.target.closest('.stop-chip');
            if (!target) return;
            chipDragEl = target;
            e.dataTransfer.effectAllowed = 'move';
          });
          stopChipsRow.addEventListener('dragover', (e) => {
            e.preventDefault();
            const after = getChipAfterElement(stopChipsRow, e.clientX);
            if (after == null) {
              stopChipsRow.appendChild(chipDragEl);
            } else {
              stopChipsRow.insertBefore(chipDragEl, after);
            }
          });
          stopChipsRow.addEventListener('drop', (e) => {
            e.preventDefault();
            const newOrder = Array.from(stopChipsRow.querySelectorAll('.stop-chip')).map(el => el.dataset.address);
            sendValue({
              type: 'reorder_stops',
              section: van.section,
              vehicle_id: van.vehicle_id,
              new_order: newOrder,
            });
          });

          // Native DnD for passengers (within/between vans)
          const paxContainers = Array.from(stopsContainer.querySelectorAll('.drag-container'));
          paxContainers.forEach((container) => {
            container.addEventListener('dragstart', (e) => {
              const row = e.target.closest('.passenger');
              if (!row) return;
              e.dataTransfer.setData('text/plain', JSON.stringify({
                type: 'passenger',
                passenger: row.dataset.passenger,
                fromAddress: row.dataset.address,
                fromSection: van.section,
                fromVehicleId: van.vehicle_id,
              }));
              e.dataTransfer.effectAllowed = 'move';
            });
            container.addEventListener('dragover', (e) => {
              e.preventDefault();
              const after = getRowAfterElement(container, e.clientY);
              const dragging = document.querySelector('.passenger.dragging');
              if (dragging) { if (after == null) container.appendChild(dragging); else container.insertBefore(dragging, after); }
            });
            container.addEventListener('dragstart', (e) => {
              const row = e.target.closest('.passenger');
              if (row) row.classList.add('dragging');
            });
            container.addEventListener('dragend', (e) => {
              const row = e.target.closest('.passenger');
              if (row) row.classList.remove('dragging');
            });
            container.addEventListener('drop', (e) => {
              e.preventDefault();
              const data = safeParse(e.dataTransfer.getData('text/plain'));
              if (!data || data.type !== 'passenger') return;
              const toAddress = container.dataset.address;
              const toSection = van.section;
              const toVehicleId = van.vehicle_id;
              if (!toAddress) return; // only drop into real stop containers
              sendValue({
                type: 'move_passenger',
                from_section: data.fromSection,
                to_section: toSection,
                from_vehicle_id: data.fromVehicleId,
                to_vehicle_id: toVehicleId,
                from_address: data.fromAddress,
                to_address: toAddress,
                passenger: data.passenger,
              });
              // Also emit reorder of this container after DOM change
              const newOrder = Array.from(container.children).map(el => el.dataset.passenger).filter(Boolean);
              sendValue({
                type: 'reorder_passengers',
                section: toSection,
                vehicle_id: toVehicleId,
                address: toAddress,
                new_order: newOrder,
              });
            });
          });

          // Allow passenger drop on chip row to create stop at position
          stopChipsRow.addEventListener('dragover', (e) => { e.preventDefault(); });
          stopChipsRow.addEventListener('drop', (e) => {
            e.preventDefault();
            const data = safeParse(e.dataTransfer.getData('text/plain'));
            if (!data || data.type !== 'passenger') return;
            const insertIndex = getChipInsertIndex(stopChipsRow, e.clientX);
            sendValue({
              type: 'create_stop_from_passenger',
              to_section: van.section,
              to_vehicle_id: van.vehicle_id,
              insert_index: insertIndex,
              passenger: data.passenger,
            });
          });
        });

        root.appendChild(grid);
        setFrameHeight(document.body.scrollHeight);
      }

      function safeParse(s) { try { return JSON.parse(s); } catch { return null; } }
      function getRowAfterElement(container, y) {
        const els = [...container.querySelectorAll('.passenger:not(.dragging)')];
        return els.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) { return { offset, element: child }; } else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }
      function getChipAfterElement(container, x) {
        const els = [...container.querySelectorAll('.stop-chip')];
        let after = null;
        for (const el of els) {
          const box = el.getBoundingClientRect();
          if (x < box.left + box.width / 2) { after = el; break; }
        }
        return after;
      }
      function getChipInsertIndex(container, x) {
        const chips = [...container.querySelectorAll('.stop-chip')];
        for (let i=0;i<chips.length;i++) {
          const box = chips[i].getBoundingClientRect();
          if (x < box.left + box.width / 2) return i;
        }
        return chips.length;
      }

      function onDataFromStreamlit(event) {
        const msg = event.data;
        if (!msg || msg.type !== 'streamlit:render') return;
        __componentId = msg.id;
        const args = msg.args || {};
        render(args.vans || []);
      }

      window.addEventListener('message', onDataFromStreamlit);
      setComponentReady();
      setFrameHeight(80);
    </script>
  </body>
  </html>


